<!DOCTYPE html>
<html lang="en">
	<head>
		
		
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		
		<link rel="canonical" href="https://rayattack.github.io/routerling/samples/">
		<link rel="shortcut icon" href="../img/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Samples - Routerling Docs</title>
		<link href="../css/bootstrap-5.0.1.min.css" rel="stylesheet">
		<link href="../css/font-awesome-5.12.2-all.min.css" rel="stylesheet">
		<link href="../css/base.css" rel="stylesheet">
		<link rel="stylesheet" href="../css/highlight-github.css">
		<script src="../js/jquery-3.5.1.min.js"></script>
		<script src="../js/bootstrap-5.0.1.min.js"></script>
		<script src="../js/highlight.pack.js"></script>
		
		<script>
			var base_url = '..';
			var home_url = '../default';
			var is_outer_page = false;
			
			var pageToc = [
				{title: "Before you go... How about some cheat codes ;-)", url: "#_top", children: [
						
				{title: "Decorators", url: "#_top", children: [
				]},
				]},
			];

		</script>
		<script src="../js/base.js"></script> 
	</head>

	<body class="inner-page">
		

		<div class="container-fluid wm-page-content">
			<a name="_top" aria-hidden="true"></a>
			






<div class="row pt-2">
	<div class="col-sm text-center text-sm-left">
		<a href="../quickstart/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../quickstart/" class="btn btn-sm btn-link">
			Quickstart
		</a>
	</div>
	

	
</div>

			

			<h2 id="before-you-go-how-about-some-cheat-codes-">Before you go... How about some cheat codes ;-)</h2>
<p>We use routerling extensively to power numerous enterprise microservices and have collated some practices that might help you
get there even faster.</p>
<h4 id="decorators">Decorators</h4>
<hr />
<p>In this example we use the <code>jsonschema</code> library to pass along validated data to our eventual handlers</p>
<pre><code class="language-py">from asyncio import iscoroutinefunction
from functools import wraps
from http import HTTPStatus

from jsonschema import validate
from jsonschema.exceptions import ValidationError
from ujson import dumps, loads


def expects(schema: dict):
    def wrapper(func):
        @wraps(func)
        async def delegate(r: HttpRequest, w: ResponseWriter, c: Context):
            try: json = loads(r.body)
            except:
                return w.status = HTTPStatus.UNPROCESSABLE_ENTITY

            try: validate(schema, json, draft7_format_checker=True)
            except ValidationError as exc:
                w.body = dumps(exc)
                return w.status = status.BAD_REQUEST

            # little helper used in example handler below -&gt; c.age, c.email
            for key in json: c.keep(key, json.get(key))

            # so you can wrap async and non async handler variants
            if iscoroutinefunction(func): return await func(r, w, c)
            else: return func(r, w, c)
        return delegate
    return wrapper


@expects({
    'type': 'object',
    'properties': {
        'age': {'type': 'number', 'min': 18, 'max': 180},
        'email': {'type': 'string', 'format': 'email'}
    },
    'required': ['age', 'email'],
    'additionalProperties': false,
})
async def create_customer_order(r: HttpRequest, w: ResponseWriter, c: Context):
    dbpool = r.app.peek('dbpool')
    async with dbpool.acquire() as sqld:
        try:
            identifier = sqld.execute('... returning id')
        except UniqueViolationsError:
            return w.status = status.SERVICE_UNAVAILABLE

    w.status = HTTPStatus.CREATED
    w.body = dumps({
        'identifier': identifier,
        'age': c.age,
        'email': c.email
    })
</code></pre>
<hr />
<p>This example demonstrates one of the ways Authentication might be implemented with the <code>pyjwt</code> library.</p>
<pre><code class="language-py">from asyncpg import Pool
from jwt import decode


def private(role: str):
    &quot;&quot;&quot;RBAC Authorization, routerling makes it easy to also use ABAC&quot;&quot;&quot;
    def wrapper(func):
        @wraps(func)
        def delegate(r: HttpRequest, w: ResponseWriter, c: Context):
            dbpool: Pool = r.app.peek('dbpool')
            with dbpool.acquire() as sqld:
                try: roles = await sqld.fetchval(&quot;&quot;&quot;
                    SELECT roles
                    FROM privileges
                    WHERE user = $1 AND action = $2
                &quot;&quot;&quot;, c.current_user, f'{r.method.lower()}s')
                except:
                    w.status = HTTPStatus.SERVICE_UNAVAILABLE
                    w.body = dumps({'message': 'please try again later'})
            if role in roles: return await func(r, w, c)

            w.status = HTTPStatus.UNAUTHORIZED
            w.body = dumps({'message': 'insufficient privileges'})
        return delegate
    return wrapper


def protected(func):
    &quot;&quot;&quot;Authentication&quot;&quot;&quot;
    @wraps(func)
    def delegate(r: HttpRequest, w: ResponseWriter, c: Context):
        token = r.headers.get('authorization')
        secret_key = r.app.CONFIG('SECRET_KEY')

        try: credentials = decode(token, secret_key, algorithm='HS256')
        except: return w.status = status.UNAUTHORIZED
        else: c.keep('current_user') = credentials.get('id')

        return await func(r, w, c)
    return delegate
</code></pre>

			<br>
			






<div class="row pt-2">
	<div class="col-sm text-center text-sm-left">
		<a href="../quickstart/" class="btn btn-sm btn-outline-dark">
			<i class="fa fa-chevron-left" aria-hidden="true"></i>
			Previous
		</a>
		<a href="../quickstart/" class="btn btn-sm btn-link">
			Quickstart
		</a>
	</div>
	

	
</div>

			<br>
		</div>

		<footer class="container-fluid wm-page-content text-center small">
			<details>
				<summary>
					Documentation built with <a href="http://www.mkdocs.org/" target="_blank">MkDocs</a> using  <a href="https://github.com/Siphalor/mkdocs-custommill" target="_blank">CustomMill</a>.
				</summary>
				<h6 class="mt-2">Additional Licenses</h6>
				<ul><li>
						CustomMill is based on the <a href="https://github.com/gristlabs/mkdocs-windmill" target="_blank">Windmill</a> theme by Grist Labs, licensed under the <a href="https://github.com/gristlabs/mkdocs-windmill/blob/master/LICENSE" target="_blank">MIT License</a>
					</li>
					<li>
						CustomMill includes <a href="https://getbootstrap.com" target="_blank">Bootstrap</a> version 5 Beta 1. This is available under the <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT License</a>.
					</li>
					<li>
						CustomMill includes <a href="https://jquery.org" target="_blank">jQuery</a> version 3.2.1. This is available under the <a href="https://jquery.org/license" target="_blank">MIT License</a>.
					</li>
					<li>
						Syntax highlighting is implemented via <a href="https://highlightjs.org" target="_blank">highlight.js</a> licensed under the BSD 3-Clause License and the included github styling made by Vasily Polovnyov.
					</li>
					<li>
						Icons on this site are from <a href="https://fontawesome.com/" target="_blank">Font Awesome</a> which is licensed under the <a href="https://fontawesome.com/license/free" target="_blank">Font Awesome Free License</a>.
					</li></ul>
				<p>Built at 2022-01-02 11:45:42 UTC</p>
			</details>
		</footer>

		
	</body>
</html>